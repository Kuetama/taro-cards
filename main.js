let savedDecks=JSON.parse(localStorage.getItem("metaphorDecks"))||[],currentDeck=null,isBackVisible=!0,shuffledDeck=[];const defaultDeck={name:"Таро Райдера Уэйта",backImage:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/back.webp",cards:[{title:"Туз кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups1.webp",description:""},{title:"Двойка кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups2.webp",description:""},{title:"Тройка кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups3.webp",description:""},{title:"Четверка кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups4.webp",description:""},{title:"Пятерка кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups5.webp",description:""},{title:"Шестерка кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups6.webp",description:""},{title:"Семерка кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups7.webp",description:""},{title:"Восьмерка кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups8.webp",description:""},{title:"Девятка кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups9.webp",description:""},{title:"Десятка кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups10.webp",description:""},{title:"Паж кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups11.webp",description:""},{title:"Рыцарь кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups12.webp",description:""},{title:"Королева кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups13.webp",description:""},{title:"Король кубков",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/cups14.webp",description:""},{title:"Туз мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords1.webp",description:""},{title:"Двойка мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords2.webp",description:""},{title:"Тройка мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords3.webp",description:""},{title:"Четверка мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords4.webp",description:""},{title:"Пятерка мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords5.webp",description:""},{title:"Шестерка мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords6.webp",description:""},{title:"Семерка мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords7.webp",description:""},{title:"ЗВосьмерка мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords8.webp",description:""},{title:"Девятка мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords9.webp",description:""},{title:"Десятка мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords10.webp",description:""},{title:"Паж мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords11.webp",description:""},{title:"Рыцарь мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords12.webp",description:""},{title:"Королева мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords13.webp",description:""},{title:"Король мечей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/swords14.webp",description:""},{title:"Туз жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands1.webp",description:""},{title:"Двойка жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands2.webp",description:""},{title:"Тройка жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands3.webp",description:""},{title:"Четверка жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands4.webp",description:""},{title:"Пятерка жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands5.webp",description:""},{title:"Шестерка жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands6.webp",description:""},{title:"Семерка жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands7.webp",description:""},{title:"Восьмерка жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands8.webp",description:""},{title:"Девятка жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands9.webp",description:""},{title:"Десятка жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands10.webp",description:""},{title:"Паж жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands11.webp",description:""},{title:"Рыцарь жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands12.webp",description:""},{title:"Королева жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands13.webp",description:""},{title:"Король жезлов",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/wands14.webp",description:""},{title:"Туз пентаклей",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents1.webp",description:""},{title:"Двойка пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents2.webp",description:""},{title:"Тройка пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents3.webp",description:""},{title:"Четверка пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents4.webp",description:""},{title:"Пятерка пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents5.webp",description:""},{title:"Шестерка пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents6.webp",description:""},{title:"Семерка пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents7.webp",description:""},{title:"Восьмерка пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents8.webp",description:""},{title:"Девятка пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents9.webp",description:""},{title:"Десятка пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents10.webp",description:""},{title:"Паж пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents11.webp",description:""},{title:"Рыцарь пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents12.webp",description:""},{title:"Королева пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents13.webp",description:""},{title:"Король пентакле",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/pents14.webp",description:""},{title:"Шут",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/0.webp",description:""},{title:"Маг",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/1.webp",description:""},{title:"Верховная жрица",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/2.webp",description:""},{title:"Императрица",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/3.webp",description:""},{title:"Император",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/4.webp",description:""},{title:"Папа",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/5.webp",description:""},{title:"Влюбленные",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/6.webp",description:""},{title:"Колесница",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/7.webp",description:""},{title:"Сила",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/8.webp",description:""},{title:"Отшельник",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/9.webp",description:""},{title:"Колесо фортуны",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/10.webp",description:""},{title:"Справедливость",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/11.webp",description:""},{title:"Повешенный",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/12.webp",description:" "},{title:"Смерть",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/13.webp",description:" "},{title:"Умеренность",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/14.webp",description:" "},{title:"Дьявол",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/15.webp",description:" "},{title:"Башня",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/16.webp",description:" "},{title:"Звезда",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/17.webp",description:" "},{title:"Луна",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/18.webp",description:" "},{title:"Солнце",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/19.webp",description:" "},{title:"Страшный суд",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/20.webp",description:" "},{title:"Мир",image:"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/21.webp",description:" "}]};function renderDeckList(){const t=document.getElementById("decksList");t&&(t.innerHTML=savedDecks.map((t,e)=>`\n    <div class="deck-item">\n      <span class="deck-name">${t.name}</span>\n      <br>\n      <button class="button">Выбрать</button>\n      ${e>0?'<button class="delete-btn danger">Удалить</button>':""}\n    </div>\n  `).join(""),t.querySelectorAll(".button").forEach((t,e)=>{t.onclick=()=>selectDeck(e)}),t.querySelectorAll(".delete-btn").forEach((t,e)=>{t.onclick=()=>deleteDeck(e+1)}))}function selectDeck(t){currentDeck=savedDecks[t],shuffledDeck=[...currentDeck.cards].sort(()=>Math.random()-.5),document.getElementById("deckInfo").textContent=`Активна: ${currentDeck.name}`,showAllCards()}function deleteDeck(t){0!==t&&confirm("Удалить колоду?")&&(savedDecks.splice(t,1),localStorage.setItem("metaphorDecks",JSON.stringify(savedDecks)),renderDeckList(),currentDeck===savedDecks[t]&&(currentDeck=null,clearTable()))}function showAllCards(){if(!currentDeck)return;const t=document.getElementById("cardsContainer");t.innerHTML="",shuffledDeck.forEach(e=>{if(isBackVisible){const a=document.createElement("div");a.className="card",a.style.position="relative",a.style.perspective="1000px";const i=document.createElement("div");i.style.transition="transform 0.6s",i.style.transformStyle="preserve-3d",i.style.position="absolute",i.style.width="100%",i.style.height="100%",i.style.top="0",i.style.left="0";const r=document.createElement("div");r.style.position="absolute",r.style.width="100%",r.style.height="100%",r.style.backfaceVisibility="hidden",r.style.borderRadius="8px",r.style.overflow="hidden";const n=document.createElement("img");n.src=currentDeck.backImage||"https://raw.githubusercontent.com/Kuetama/taro-cards/main/RyderWaite/back.webp",n.alt="Рубашка",n.style.width="100%",n.style.height="100%",n.style.objectFit="cover",r.appendChild(n);const s=document.createElement("div");s.style.position="absolute",s.style.width="100%",s.style.height="100%",s.style.backfaceVisibility="hidden",s.style.transform="rotateY(180deg)",s.style.borderRadius="8px",s.style.overflow="hidden",s.innerHTML=`<img src="${e.image}" alt="${e.title}" style="width:100%;height:100%;object-fit:contain;padding:5px">`,i.appendChild(r),i.appendChild(s),a.appendChild(i),a.onclick=()=>{a.dataset.flipped?showCardModal(e):(a.dataset.flipped="true",i.style.transform="rotateY(180deg)",setTimeout(()=>showCardModal(e),300))},t.appendChild(a)}else{const a=document.createElement("div");a.className="card",a.innerHTML=`<img src="${e.image}" alt="${e.title}" style="width:100%;height:100%;object-fit:contain;border-radius:8px;">`,a.style.cursor="pointer",a.style.boxShadow="0 4px 8px rgba(0,0,0,0.2)",a.onclick=()=>showCardModal(e),t.appendChild(a)}})}function showCardModal(t){const e=document.getElementById("modalImage"),a=document.getElementById("modalDesc");document.getElementById("modalTitle").textContent=t.title,e.src=t.image,e.style.display="block",a.textContent=t.description,document.getElementById("modal").classList.remove("hidden")}function closeModal(){document.getElementById("modal").classList.add("hidden")}function showRandomCard(){if(!currentDeck)return alert("Нет активной колоды!");showCardModal(currentDeck.cards[Math.floor(Math.random()*currentDeck.cards.length)])}function showThreeRandomCards(){if(!currentDeck)return alert("Нет активной колоды!");const t=currentDeck.cards;let e=[...new Set(Array.from({length:100},()=>Math.floor(Math.random()*t.length)))].slice(0,3).map(e=>{const a=t[e];return`<div style="display:inline-block;margin:10px;text-align:center;max-width:250px;">\n      <img src="${a.image}" style="width:100%;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">\n      <div>${a.title}</div>\n      <div>${a.description}</div>\n    </div>`}).join("");document.getElementById("modalTitle").textContent="Три карты",document.getElementById("modalImage").style.display="none",document.getElementById("modalDesc").innerHTML=e,document.getElementById("modal").classList.remove("hidden")}function shuffleOnTable(){const t=document.getElementById("cardsContainer"),e=Array.from(t.children);if(0===e.length)return alert("Нет карт!");if(t.classList.contains("shuffling"))return;t.classList.add("shuffling");const a=e.map(t=>t.getBoundingClientRect()),i=[...e].sort(()=>Math.random()-.5);t.replaceChildren(...i);const r=e.map(t=>t.getBoundingClientRect());e.forEach((t,e)=>{const i=a[e].left-r[e].left,n=a[e].top-r[e].top;t.style.transform=`translate(${i}px, ${n}px)`,t.style.transition="none"}),t.offsetHeight,e.forEach(t=>{t.style.transition="transform 0.7s cubic-bezier(0.34, 1.56, 0.64, 1)",t.style.transform="translate(0, 0)"}),setTimeout(()=>{e.forEach(t=>{t.style.transition="",t.style.transform=""}),t.classList.remove("shuffling")},700)}function clearTable(){document.getElementById("cardsContainer").innerHTML="",document.getElementById("deckInfo").textContent="Стол очищен"}function toggleBack(){isBackVisible=!isBackVisible,document.getElementById("toggleBackBtn").textContent=isBackVisible?"Рубашка: ВКЛ":"Рубашка: ВЫКЛ",currentDeck&&showAllCards()}0===savedDecks.length&&(savedDecks=[defaultDeck],localStorage.setItem("metaphorDecks",JSON.stringify(savedDecks))),document.addEventListener("DOMContentLoaded",()=>{renderDeckList(),document.getElementById("loadDeckBtn")?.addEventListener("click",()=>{document.getElementById("fileInput")?.click()}),document.getElementById("howToBtn")?.addEventListener("click",()=>{window.location.href="how-to.html"}),document.getElementById("show1Btn")?.addEventListener("click",showRandomCard),document.getElementById("show3Btn")?.addEventListener("click",showThreeRandomCards),document.getElementById("shuffleBtn")?.addEventListener("click",shuffleOnTable),document.getElementById("clearBtn")?.addEventListener("click",clearTable),document.getElementById("toggleBackBtn")?.addEventListener("click",toggleBack),document.getElementById("closeModal")?.addEventListener("click",closeModal),document.getElementById("fileInput")?.addEventListener("change",t=>{const e=t.target.files[0];if(!e)return;const a=new FileReader;a.onload=t=>{try{const e=JSON.parse(t.target.result);if(!e.name||!Array.isArray(e.cards)||0===e.cards.length)throw new Error("Неверный формат");savedDecks.push(e),localStorage.setItem("metaphorDecks",JSON.stringify(savedDecks)),renderDeckList(),alert("Колода добавлена!")}catch(t){alert("❌ Ошибка: "+t.message)}},a.readAsText(e),t.target.value=""})});const CACHE_NAME="taro-cards-v1",urlsToCache=["/","/index.html","/style.css","/app.js","/how-to.html","/icon-192.png","/icon-512.png"];self.addEventListener("install",t=>{t.waitUntil(caches.open(CACHE_NAME).then(t=>t.addAll(urlsToCache)))}),self.addEventListener("fetch",t=>{t.respondWith(caches.match(t.request).then(e=>e||fetch(t.request)))});